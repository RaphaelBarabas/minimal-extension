<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Activity id</title>
  </head>
  <body>
    <div>
      <h1>Activity id</h1>
      <h2 id="info">'loading ...'</h2>
    </div>
    <script src="https://unpkg.com/fsm-shell"></script>
    <script>
      const updateUI = (text) =>
        (document.querySelectorAll('#info')[0].innerText = text);

      try {
        const { ShellSdk, SHELL_EVENTS } = FSMShell;
        console.log('using ShellSdk version', ShellSdk.VERSION);

        if (!ShellSdk.isInsideShell()) {
          throw new Error('unable to reach shell eventAPI');
        }

        const shellSdk = ShellSdk.init(parent, '*');

        // get context
        shellSdk.emit(SHELL_EVENTS.Version1.REQUIRE_CONTEXT, {
          clientIdentifier: 'example-plugin',
        });

        shellSdk.on(SHELL_EVENTS.Version1.REQUIRE_CONTEXT, (event) => {
          const {
            cloudHost,
            account,
            accountId,
            company,
            companyId,
            user,
            userId,
            selectedLocale,
            auth
          } = JSON.parse(event);
          
          updateUI(`Hi ${cloudHost} / ${user} / ${account} / ${company}!`);
          updateUI(`${activityID}`);
          console.log('ActivityID: ', activityID);

          initializeRefreshTokenStrategy(shellSdk, auth);

          const headers = {
            'Content-Type': 'application/json',
            'X-Client-ID': 'fsm-extension-sample',
            'X-Client-Version': '1.0.0',
            'Authorization': `bearer ${sessionStorage.getItem('token')}`
          };

          const activity = new Promise(resolve => {
          fetch(`https://${cloudHost}/api/data/v4/Activity/${activityID}?dtos=Activity.42&account=${account}&company=${company}`, {
            headers
            })
            .then(response => response.json())
            .then(function(json) {
              resolve(json.data[0].activity);
            });
          });

        });
      } catch (e) {
        updateUI(`Exception: ${e.message}`);
      }
    </script>
  </body>
</html>
